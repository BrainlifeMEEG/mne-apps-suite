# Brainlife Apps Refactoring Status

## Overview
This document tracks the systematic refactoring of Brainlife.io apps to use the shared `brainlife_utils` package, eliminating code duplication and improving maintainability across the suite of neuroimaging processing applications.

## Refactoring Process (4 Steps Per App)

1. **Create Feature Branch**: `git checkout -b refactor-shared-utils`
2. **Refactor Code**: Update main.py with brainlife_utils, update README.md and config.json
3. **Commit Changes**: `git add main.py README.md config.json && git commit -m "refactor: use shared brainlife_utils library"`
4. **Add Submodule**: `git submodule add https://github.com/BrainlifeMEEG/brainlife_utils.git brainlife_utils && git commit -m "feat: add brainlife_utils as git submodule"`

### Critical Rules
- **NEVER commit product.json to repository** - It is generated at runtime by main.py when executed on Brainlife.io
- Always include module docstring in main.py describing inputs/outputs
- Follow the documentation structure established in refactored examples
- Add parameter documentation to config.json

## Completed Refactorings

The following apps are to be refactored (in suggested priority order):

### Apps in the current Latinus Data pipeline
- [X] app-egi2mne
- [X] app-interpolate-raw
- [X] app-mark_bad-raw
- [X] app-add_flat_chan
- [X] app-concat
- [X] app-add-montage
- [X] app-epoch
- [X] app-info-raw
- [X] app-ICA-fit - ICA fit computation
- [X] app-ICA-fit-epo - ICA fit on epochs
- [X] app-ICA-apply - Apply ICA components
- [X] app-ICA-apply-epo - Apply ICA on epochs
- [X] app-drop-bad-epo - Drop bad epochs
- [ ] app-ICA-plot - Visualize ICA components This app still belongs to Saeed. Need to ask him to change ownership of the app on Brainlife.io

### Data Conversion Apps
- [ ] app_bdf2mne - Biodat BDF to MNE conversion
- [ ] app_brainvision2mne - Brain Vision to MNE conversion
- [ ] app_ctf2mne - CTF MEG to MNE conversion
- [ ] app_edf2mne - EDF to MNE conversion
- [ ] app_eeglab2mne - EEGLAB to MNE conversion
- [ ] app_fif2mne - FIF file refinement

### Channel Operations 
- [ ] app-add_flat_chan - Add flat channels
- [ ] app-add-montage - Add electrode montage
- [ ] app-average-channels - Average across channels

### Filtering & Preprocessing
- [ ] app-filter-raw - Temporal filtering on raw data
- [ ] app-filter-epo - Temporal filtering on epochs
- [ ] app-notch-filter - Notch filtering
- [ ] app-temporal-filtering - Advanced temporal filtering

### Analysis & Features
- [ ] app-psd - Power spectral density analysis
- [ ] app-peak-amplitude - Peak amplitude detection
- [ ] app-detect-alpha-peak - Alpha peak detection
- [ ] app-epoch-psd - Epoched power spectral density

### Projection & Artifact Removal
- [X] app-ICA-plot - Visualize ICA components
- [ ] app-SSP-projectors-ECG - ECG projector computation
- [ ] app-SSP-projectors-EOG - EOG projector computation
- [ ] app-SSP-apply - Apply SSP projectors
- [ ] app-plot_proj_topomaps-raw - Visualize projectors

### Epoching & Events
- [ ] app-epoch - Epoch extraction
- [ ] app-epoch-psd - Epoched PSD analysis
- [ ] app-events - Event detection
- [ ] app-eventslog - Event logging
- [ ] app-evoked-averaged - Evoked response averaging

### Advanced Processing
- [ ] app-resampling - Data resampling
- [ ] app-head-pos - Head position analysis
- [ ] app-maxfilter - Maxwell filtering
- [ ] app-make-watershed-bem - BEM surface creation
- [ ] app-mean-transformation-matrix - Transformation matrix computation
- [ ] app-emptyroom-proj - Empty room projector computation
- [ ] app-info-* - Data information viewers (raw, epo, evoked)

## Key Utilities Available

### Configuration
- `load_config()` - Load and preprocess configuration from config.json
- Handles parameter validation and type conversion

### File Operations
- `ensure_output_dirs()` - Create standard output directories (out_dir, out_figs, out_report)
- Path management and validation

### Reporting
- `create_product_json()` - Create product.json for Brainlife.io interface
- `add_info_to_product()` - Add text messages with type validation (info, warning, error, danger, success)
- `add_image_to_product()` - Add base64-encoded PNG images
- `add_plotly_to_product()` - Add interactive Plotly charts
- `add_raw_info_to_product()` - Extract and format raw data metadata (channels, sfreq, duration, filters, projectors)

### Plotting
- `setup_matplotlib_backend()` - Configure Agg backend for headless execution
- `plot_utils` - Matplotlib helper functions

## Documentation Structure

All refactored apps should follow this README.md structure:

1. **Description** - What the app does and its purpose
2. **Inputs** - Input files with formats and descriptions
3. **Outputs** - Output files generated by the app
4. **Configuration Parameters** - config.json parameters with types and descriptions
5. **Usage** - Example command line or execution instructions
6. **Technical Details** - MNE-specific implementation details
7. **Authors** - Contribution information
8. **Citations** - Academic citations and references
9. **Funding** - Funding acknowledgments

## Common Patterns

### Module Docstring Template
```python
"""
[App Name]: [Brief description]

This app [detailed functionality description].

Inputs:
- config.json:
  - [param1] ([type]): [description]
  - [param2] ([type]): [description]

Outputs:
- out_dir/: Primary output data
  - [file1]: [description]
  - [file2]: [description]
- out_figs/: PNG figures and visualizations
- out_report/: HTML reports
- product.json: Metadata for Brainlife.io interface
"""
```

### Main Code Pattern
```python
import sys
import os
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'brainlife_utils'))

from brainlife_utils import (
    load_config, 
    setup_matplotlib_backend, 
    ensure_output_dirs,
    create_product_json,
    add_info_to_product,
    add_raw_info_to_product,
    add_image_to_product
)

# Setup
setup_matplotlib_backend()
config = load_config()
ensure_output_dirs('out_dir', 'out_figs', 'out_report')

# Processing (app-specific logic)

# Output
product_items = []
add_raw_info_to_product(product_items, raw)  # If working with raw data
add_image_to_product(product_items, figure, 'filename.png')  # For figures
add_info_to_product(product_items, "Processing complete")  # For messages
create_product_json(product_items)
```

## Recent Batch Refactorings (January 2026)

### ICA Component Suite (5 apps)
All 5 ICA apps have been refactored and pushed to their respective repositories on the `refactor-shared-utils` branch:
- **app-ICA-apply** (BrainlifeMEEG owner): PR ready at https://github.com/BrainlifeMEEG/app-ICA-apply/pull/new/refactor-shared-utils
- **app-ICA-fit** (dnacombo owner): Pushed to myorigin
- **app-ICA-fit-epo** (dnacombo owner): Pushed to myorigin
- **app-ICA-apply-epo** (dnacombo owner): Pushed to myorigin
- **app-ICA-plot** (dnacombo owner): Pushed to myorigin

### Epoch Processing (1 app)
- **app-drop-bad-epo** (BrainlifeMEEG owner): PR ready at https://github.com/BrainlifeMEEG/app-drop-bad-epo/pull/new/refactor-shared-utils

All refactorings follow the established 4-step process and include:
- ✅ Module docstrings describing inputs/outputs
- ✅ `brainlife_utils` imports and usage
- ✅ Proper error handling and parameter validation
- ✅ `product.json` generation with metadata
- ✅ Informative logging and progress messages
- ✅ Consistent code structure with other refactored apps

## Next Steps

1. **Select next app to refactor** based on priority and dependencies
2. **Follow the 4-step process** consistently
3. **Test refactored apps** with sample data
4. **Verify product.json output** is properly formatted for Brainlife.io
5. **Document any app-specific utilities** that can't be consolidated to shared utils

## Notes

- Product.json generation is critical - apps must output valid JSON that Brainlife.io can parse
- Always validate inputs and handle edge cases gracefully
- Maintain backward compatibility with existing Brainlife.io configurations
- Consider adding type hints in refactored code for better IDE support
